<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.jzt56.singleticketsystem.mapper.AuctionTaskMapper">
    <!--竞价任务数据库表与实体类字段对接-->
    <resultMap id="auctionTaskResultMap" type="cn.jzt56.singleticketsystem.entity.AuctionTask">
        <id column="Bid_Task_Id" property="bidTaskId" jdbcType="VARCHAR"/>
        <result column="Ord_Id" property="orderId" jdbcType="VARCHAR"/>
        <result column="User_Id" property="userId" javaType="STRING"/>
        <result column="Total_Quantity" property="totalQuantity" jdbcType="VARCHAR"/>
        <result column="Total_Volume" property="totalVolume" jdbcType="VARCHAR"/>
        <result column="Total_Weight" property="totalWeight" jdbcType="VARCHAR"/>
        <result column="Proposed_Price" property="proposedPrice" jdbcType="DECIMAL"/>
        <result column="Pick_Area" property="pickArea" jdbcType="VARCHAR"/>
        <result column="Deliver_Area" property="deliverArea" jdbcType="VARCHAR"/>
        <result column="Service_Time" property="serviceTime" jdbcType="VARCHAR"/>
        <result column="Release_Time" property="releaseTime" jdbcType="VARCHAR"/>
        <result column="SealedDisk_Time" property="sealedDiskTime" jdbcType="VARCHAR"/>
        <result column="Bid_Status" property="bidStatus" jdbcType="VARCHAR"/>
        <result column="Transaction_Price" property="transactionPrice" jdbcType="DECIMAL"/>
        <result column="Task_Type" property="taskType" jdbcType="VARCHAR"/>
        <result column="Bid_Task_Num" property="bidTaskNum" jdbcType="VARCHAR"/>
    </resultMap>
    <!--竞价后数据接收-->
    <resultMap id="auctionTaskViewMapper" type="cn.jzt56.singleticketsystem.tools.AuctionTaskView">
        <id column="Bid_Task_Id" property="bidTaskId" jdbcType="VARCHAR"/>
        <result column="Ord_Id" property="orderId" jdbcType="VARCHAR"/>
        <result column="User_Id" property="userId" javaType="STRING"/>
        <result column="Total_Quantity" property="totalQuantity" jdbcType="VARCHAR"/>
        <result column="Total_Volume" property="totalVolume" jdbcType="VARCHAR"/>
        <result column="Total_Weight" property="totalWeight" jdbcType="VARCHAR"/>
        <result column="Proposed_Price" property="proposedPrice" jdbcType="DECIMAL"/>
        <result column="Pick_Area" property="pickArea" jdbcType="VARCHAR"/>
        <result column="Deliver_Area" property="deliverArea" jdbcType="VARCHAR"/>
        <result column="Service_Time" property="serviceTime" jdbcType="VARCHAR"/>
        <result column="Release_Time" property="releaseTime" jdbcType="VARCHAR"/>
        <result column="SealedDisk_Time" property="sealedDiskTime" jdbcType="VARCHAR"/>
        <result column="Bid_Status" property="bidStatus" jdbcType="VARCHAR"/>
        <result column="Transaction_Price" property="transactionPrice" jdbcType="DECIMAL"/>
        <result column="Task_Type" property="taskType" jdbcType="VARCHAR"/>
        <result column="Bid_Task_Num" property="bidTaskNum" jdbcType="VARCHAR"/>
        <result column="Quoted_Price" property="quotedPrice" jdbcType="VARCHAR"/>
    </resultMap>
    <!-- 条件查询 -->
    <sql id="selectCondition">
        <!-- 可竞价的任务单id -->
        <if test="bidTaskId !=null">
            AND Bid_Task_Id=#{bidTaskId}
        </if>
        <!-- 取货地址 -->
        <if test="pickArea  != null">
            AND Pick_Area LIKE CONCAT('%', #{pickArea},'%')
        </if>
        <!--配送地址 -->
        <if test="deliverArea  != null">
            AND  Deliver_Area LIKE CONCAT(CONCAT('%', #{deliverArea}),'%')
        </if>
        <!--件数 -->
        <if test="totalQuantity !=null">
            AND Total_Quantity=#{totalQuantity}
        </if>
        <!-- 类型 -->
        <if test="taskType !=null">
            AND Task_Type=#{taskType}
        </if>
        <!-- 时效 -->
        <choose>
            <when test="serviceTime==0">
                AND Service_Time-INTERVAL 72 HOUR &lt; NOW()
            </when>
            <when test="serviceTime==1">
                AND
                NOW()&lt;=Service_Time-INTERVAL 72 HOUR AND Service_Time-INTERVAL 120 HOUR &lt;= NOW()
            </when>
            <when test="serviceTime==2">
                AND  NOW() &lt;Service_Time -INTERVAL 120 HOUR
            </when>
        </choose>
        <!-- 体积 -->
        <choose>
            <when test="totalVolume==0">
                AND Total_Volume &lt;10
            </when>
            <when test="totalVolume==1">
                AND 10 &lt;=Total_Volume AND  Total_Volume &lt;=100
            </when>
            <when test="totalVolume==2">
                AND 100 &lt;Total_Volume
            </when>
        </choose>
        <!-- 重量 -->
        <choose>
            <when test="totalWeight==0">
                AND Total_Weight &lt;10
            </when>
            <when test="totalWeight==1">
                AND 10 &lt;=Total_Weight AND Total_Weight &lt;=100
            </when>
            <when test="totalWeight==2">
                AND 100 &lt;Total_Weight
            </when>
        </choose>
        <!--参考价 -->
        <choose>
            <when test="proposedPrice==0">
                AND Proposed_Price &lt;50
            </when>
            <when test="proposedPrice==1">
                AND 50 &lt;=Proposed_Price AND Proposed_Price &lt;=100
            </when>
            <when test="proposedPrice==2">
                AND 100 &lt;Proposed_Price
            </when>
        </choose>
    </sql>

    <!-- 查询所有可竞价的任务单 -->
    <select id="findAllCurrentTask" parameterType="cn.jzt56.singleticketsystem.entity.AuctionTask" resultMap="auctionTaskResultMap">
        SELECT att.* FROM auction_task  att WHERE att.Bid_Task_Id
        NOT IN(SELECT bd.Bid_Task_Id FROM bidding_detail bd WHERE bd.User_Id= #{userId} AND Status='1')
        AND Bid_Status='1'
        <include refid="selectCondition"/>
    </select>

    <!-- 查询正在竞价的任务单 -->
    <select id="findBidded" parameterType="cn.jzt56.singleticketsystem.tools.AuctionTaskView" resultMap="auctionTaskViewMapper">
        SELECT att.*,bd.Quoted_Price FROM auction_task att RIGHT  JOIN bidding_detail bd
          ON att.Bid_Task_Id=bd.Bid_Task_Id WHERE  bd.User_Id =#{userId} AND att.User_Id in ('',null)  AND bd.Status='1'
        <!--竞价 -->
        <choose>
            <when test="quotedPrice==0">
                AND Quoted_Price &lt;50
            </when>
            <when test="quotedPrice==1">
                AND 50 &lt;=Quoted_Price &lt;=100
            </when>
            <when test="quotedPrice==2">
                AND 100 &lt;Quoted_Price
            </when>
        </choose>
        <include refid="selectCondition"/>
    </select>


    <!-- 根据运输商id查询竞拍成功的订单 -->
    <select id="findAllSuccessCurrentTaskByUserId" parameterType="String" resultMap="auctionTaskResultMap">
        SELECT *  FROM	auction_task
        WHERE
	      Bid_Status = '2'
        AND
          User_Id = #{userId}
    </select>


    <!-- 竞拍成功 -->
    <update id="biddedSuccess" parameterType="cn.jzt56.singleticketsystem.tools.AuctionTaskView">
        UPDATE auction_task SET Transaction_Price=#{quotedPrice},Bid_Status='2',User_Id=#{UserId} WHERE Bid_Task_Id=#{bidTaskId} AND Proposed_Price &gt; #{quotedPrice} AND User_Id in ('',null) AND Bid_Status='1'
    </update>
    <!--流拍 -->
    <update id="biddedFail" parameterType="cn.jzt56.singleticketsystem.tools.AuctionTaskView">
        UPDATE auction_task a1,auction_task a2 SET a1.Transaction_Price=a2.Proposed_Price,a1.Bid_Status='2',a1.User_Id=#{UserId} WHERE a1.Bid_Task_Id=a2.Bid_Task_Id
        AND  a1.Bid_Task_Id=#{bidTaskId} AND a1.Proposed_Price &gt; #{quotedPrice} AND a1.User_Id in ('',null) AND a1.Bid_Status='1'
    </update>
</mapper>