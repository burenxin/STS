<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.jzt56.singleticketsystem.mapper.BiddingDetailMapper">
    <!-- 当前用户不存在竞价就插入 -->
    <insert id="addBiddingDetail" parameterType="cn.jzt56.singleticketsystem.entity.BiddingDetail">
        INSERT INTO bidding_detail
        (Detail_Id,Bid_Task_Id, User_Id, Quoted_Price,Participation_Time,STATUS)
        SELECT #{detailId}, #{bidTaskId}, #{userId} ,#{quotedPrice},NOW(),'1'
        FROM dual
        WHERE NOT exists (select * from bidding_detail bd
        where bd.Bid_Task_Id = #{bidTaskId} AND bd.User_Id=#{userId} AND Status='1' );
    </insert>
    <!--修改报价-->
    <update id="updateQuotedPrice">
        UPDATE  bidding_detail SET Quoted_Price=#{quotedPrice} WHERE Bid_Task_Id=#{bidTaskId} AND User_Id=#{userId} AND Status='1'
    </update>
    <!--取消报价-->
    <update id="cancelBidding">
        UPDATE  bidding_detail SET Status='0' WHERE Bid_Task_Id=#{bidTaskId} AND User_Id=#{userId} AND Status='1'
    </update>
    <!--查询竞价任务-->
    <select id="findBiddingEnd">
        SELECT t1.Bid_Task_Id,t1.User_Id,t1.Quoted_Price FROM(
            SELECT * FROM bidding_detail WHERE `Status`='1' AND Participation_Time + INTERVAL 2 HOUR>NOW()
            ORDER BY Bid_Task_Id,Quoted_Price,Participation_Time
         )t1  GROUP BY t1.Bid_Task_Id
    </select>
</mapper>